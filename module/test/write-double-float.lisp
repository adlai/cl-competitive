(defpackage :cp/test/write-double-float
  (:use :cl :fiveam :cp/write-double-float)
  (:import-from :cp/test/base #:base-suite))
(in-package :cp/test/write-double-float)
(in-suite base-suite)

(defun %make-df-string (x &key (max-decimal-places 10) (allow-trailing-point t))
  (with-output-to-string (out)
    (write-double-float x :max-decimal-places max-decimal-places
                          :stream out
                          :allow-trailing-point allow-trailing-point)))

(test write-double-float
  (is (equal "1.0" (%make-df-string 1d0 :allow-trailing-point nil)))
  (is (equal "1." (%make-df-string 1d0)))
  ;; 2
  (is (equal "2." (%make-df-string 2d0)))
  (is (equal "20." (%make-df-string 2d1)))
  (is (equal "200." (%make-df-string 2d2)))
  (is (equal "2000." (%make-df-string 2d3)))
  (is (equal "-2." (%make-df-string -2d0)))
  (is (equal "-20." (%make-df-string -2d1)))
  (is (equal "-200." (%make-df-string -2d2)))
  (is (equal "-2000." (%make-df-string -2d3)))
  (is (equal "0.2" (%make-df-string 2d-1)))
  (is (equal "0.02" (%make-df-string 2d-2)))
  (is (equal "0.002" (%make-df-string 2d-3)))
  (is (equal "-0.2" (%make-df-string -2d-1)))
  (is (equal "-0.02" (%make-df-string -2d-2)))
  (is (equal "-0.002" (%make-df-string -2d-3)))
  
  (is (equal "1.55" (%make-df-string 1.55d0)))
  (is (equal "15.5" (%make-df-string 1.55d1)))
  (is (equal "155." (%make-df-string 1.55d2)))
  (is (equal "1550." (%make-df-string 1.55d3)))
  (is (equal "-1.55" (%make-df-string -1.55d0)))
  (is (equal "-15.5" (%make-df-string -1.55d1)))
  (is (equal "-155." (%make-df-string -1.55d2)))
  (is (equal "-1550." (%make-df-string -1.55d3)))
  (is (equal "0.155" (%make-df-string 1.55d-1)))
  (is (equal "0.0155" (%make-df-string 1.55d-2)))
  (is (equal "0.00155" (%make-df-string 1.55d-3)))
  (is (equal "-0.155" (%make-df-string -1.55d-1)))
  (is (equal "-0.0155" (%make-df-string -1.55d-2)))
  (is (equal "-0.00155" (%make-df-string -1.55d-3)))

  (is (equal "-2.33333" (%make-df-string -2.33333333d0 :max-decimal-places 5)))
  (is (equal "-2.3333" (%make-df-string -2.33333333d0 :max-decimal-places 4)))
  (is (equal "-2.333" (%make-df-string -2.33333333d0 :max-decimal-places 3)))
  (is (equal "-2.33" (%make-df-string -2.33333333d0 :max-decimal-places 2)))
  (is (equal "-2.3" (%make-df-string -2.33333333d0 :max-decimal-places 1)))
  (is (equal "-2." (%make-df-string -2.33333333d0 :max-decimal-places 0)))
  (is (equal "-2.0" (%make-df-string -2.33333333d0 :max-decimal-places 0 :allow-trailing-point nil)))

  (is (equal "-0.23333" (%make-df-string -2.33333333d-1 :max-decimal-places 5)))
  (is (equal "-0.2333" (%make-df-string -2.33333333d-1 :max-decimal-places 4)))
  (is (equal "-0.233" (%make-df-string -2.33333333d-1 :max-decimal-places 3)))
  (is (equal "-0.23" (%make-df-string -2.33333333d-1 :max-decimal-places 2)))
  (is (equal "-0.2" (%make-df-string -2.33333333d-1 :max-decimal-places 1)))
  (is (equal "-0." (%make-df-string -2.33333333d-1 :max-decimal-places 0))))
