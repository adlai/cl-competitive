(eval-when (:compile-toplevel :load-toplevel :execute)
  (load "test-util")
  (load "../write-double-float.lisp"))

(use-package :test-util)

(defun %make-df-string (x &key (max-digits 10) (allow-trailing-point t))
  (with-output-to-string (out)
    (write-double-float x :max-digits max-digits
                          :stream out
                          :allow-trailing-point allow-trailing-point)))

(with-test (:name write-double-float)
  (assert (equal "1.0" (%make-df-string 1d0 :allow-trailing-point nil)))
  (assert (equal "1." (%make-df-string 1d0)))
  ;; 2
  (assert (equal "2." (%make-df-string 2d0)))
  (assert (equal "20." (%make-df-string 2d1)))
  (assert (equal "200." (%make-df-string 2d2)))
  (assert (equal "2000." (%make-df-string 2d3)))
  (assert (equal "-2." (%make-df-string -2d0)))
  (assert (equal "-20." (%make-df-string -2d1)))
  (assert (equal "-200." (%make-df-string -2d2)))
  (assert (equal "-2000." (%make-df-string -2d3)))
  (assert (equal "0.2" (%make-df-string 2d-1)))
  (assert (equal "0.02" (%make-df-string 2d-2)))
  (assert (equal "0.002" (%make-df-string 2d-3)))
  (assert (equal "-0.2" (%make-df-string -2d-1)))
  (assert (equal "-0.02" (%make-df-string -2d-2)))
  (assert (equal "-0.002" (%make-df-string -2d-3)))
  
  (assert (equal "1.55" (%make-df-string 1.55d0)))
  (assert (equal "15.5" (%make-df-string 1.55d1)))
  (assert (equal "155." (%make-df-string 1.55d2)))
  (assert (equal "1550." (%make-df-string 1.55d3)))
  (assert (equal "-1.55" (%make-df-string -1.55d0)))
  (assert (equal "-15.5" (%make-df-string -1.55d1)))
  (assert (equal "-155." (%make-df-string -1.55d2)))
  (assert (equal "-1550." (%make-df-string -1.55d3)))
  (assert (equal "0.155" (%make-df-string 1.55d-1)))
  (assert (equal "0.0155" (%make-df-string 1.55d-2)))
  (assert (equal "0.00155" (%make-df-string 1.55d-3)))
  (assert (equal "-0.155" (%make-df-string -1.55d-1)))
  (assert (equal "-0.0155" (%make-df-string -1.55d-2)))
  (assert (equal "-0.00155" (%make-df-string -1.55d-3)))

  (assert (equal "-2.33333" (%make-df-string -2.33333333d0 :max-digits 5)))
  (assert (equal "-2.3333" (%make-df-string -2.33333333d0 :max-digits 4)))
  (assert (equal "-2.333" (%make-df-string -2.33333333d0 :max-digits 3)))
  (assert (equal "-2.33" (%make-df-string -2.33333333d0 :max-digits 2)))
  (assert (equal "-2.3" (%make-df-string -2.33333333d0 :max-digits 1)))
  (assert (equal "-2." (%make-df-string -2.33333333d0 :max-digits 0)))
  (assert (equal "-2.0" (%make-df-string -2.33333333d0 :max-digits 0 :allow-trailing-point nil)))

  (assert (equal "-0.23333" (%make-df-string -2.33333333d-1 :max-digits 5)))
  (assert (equal "-0.2333" (%make-df-string -2.33333333d-1 :max-digits 4)))
  (assert (equal "-0.233" (%make-df-string -2.33333333d-1 :max-digits 3)))
  (assert (equal "-0.23" (%make-df-string -2.33333333d-1 :max-digits 2)))
  (assert (equal "-0.2" (%make-df-string -2.33333333d-1 :max-digits 1)))
  (assert (equal "-0." (%make-df-string -2.33333333d-1 :max-digits 0))))
